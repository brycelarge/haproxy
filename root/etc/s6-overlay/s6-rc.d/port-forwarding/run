#!/usr/bin/with-contenv bash
# shellcheck shell=bash

# This script sets up port forwarding for HTTP/3 when MIXED_SSL_MODE is enabled
# It forwards UDP traffic from port 443 to port 8443 inside the container using socat
# This runs as a longrun service during container lifetime

if [ "${MIXED_SSL_MODE}" = "true" ]; then
    echo "[port-forwarding] MIXED_SSL_MODE is enabled, setting up UDP port forwarding from 443 to 8443..." | ts '%Y-%m-%d %H:%M:%S'

    # Check if socat is available
    if ! command -v socat &> /dev/null; then
        echo "[port-forwarding] Error: socat is not installed. Cannot set up port forwarding." | ts '%Y-%m-%d %H:%M:%S'
        exit 1
    fi

    # Kill any existing socat processes for this port
    pkill -f "socat UDP-LISTEN:443" 2>/dev/null

    # Start socat to forward UDP traffic
    echo "[port-forwarding] Starting socat UDP port forwarding from 443 to 8443" | ts '%Y-%m-%d %H:%M:%S'
    exec socat UDP-LISTEN:443,fork UDP:127.0.0.1:8443
else
    echo "[port-forwarding] MIXED_SSL_MODE is disabled, no port forwarding needed" | ts '%Y-%m-%d %H:%M:%S'
    # Sleep forever since this is a longrun service
    exec sleep infinity
fi